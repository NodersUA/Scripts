#!/bin/bash

sudo tee /root/.kuzco/kuzco-logs-monitor.sh > /dev/null <<EOF
#!/bin/bash

# Функція для перезапуску сервісу kuzco
restart_kuzco() {
  echo "\$(date): Restarting kuzco..."
  systemctl restart kuzco
  sleep 5
}

# Функція для оновлення kuzco CLI
upgrade_kuzco() {
  echo "\$(date): Upgrading kuzco CLI..."
  kuzco upgrade
  sleep 5
  echo "\$(date): Upgrade completed, restarting kuzco..."
  restart_kuzco
  sleep 5
}

# Відстежування виводу команди в реальному часі
kuzco worker logs | while read line
do
  echo "\$line" | grep "NatsError: consumer not found" &> /dev/null
  if [[ \$? -eq 0 ]]; then
    restart_kuzco
  fi

  echo "\$line" | grep "Run \`kuzco upgrade\` to update the CLI" &> /dev/null
  if [[ \$? -eq 0 ]]; then
    upgrade_kuzco
  fi
done
EOF

chmod +x /root/.kuzco/kuzco-logs-monitor.sh

sudo tee /etc/systemd/system/ar_kuzco.service > /dev/null <<EOF
[Unit]
Description=Monitor kuzco worker logs and restart service on specific errors
After=network.target

[Service]
Type=simple
ExecStart=/root/.kuzco/kuzco-logs-monitor.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable ar_kuzco
systemctl start ar_kuzco
