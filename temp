#!/bin/bash

chmod +x /usr/local/bin/namada*

# Set the variables
echo "export NAMADA_CHAIN_ID=public-testnet-15.0dacadb8d663" >> $HOME/.bash_profile
echo "export NAMADA_PORT=41" >> $HOME/.bash_profile
source $HOME/.bash_profile

namada client utils join-network --chain-id $NAMADA_CHAIN_ID

sed -i.bak -e "s%:26658%:${NAMADA_PORT}658%g;
s%:26657%:${NAMADA_PORT}657%g;
s%:26656%:${NAMADA_PORT}656%g;
s%:26545%:${NAMADA_PORT}545%g;
s%:8545%:${NAMADA_PORT}545%g;
s%:26660%:${NAMADA_PORT}660%g" ~/.local/share/namada/$NAMADA_CHAIN_ID/config.toml

# Open ports
ufw allow ${NAMADA_PORT}658
ufw allow ${NAMADA_PORT}657
ufw allow ${NAMADA_PORT}545
ufw allow ${NAMADA_PORT}660

sudo tee /etc/systemd/system/namadad.service > /dev/null <<EOF
[Unit]
Description=namada
After=network-online.target
[Service]
User=$USER
WorkingDirectory=$HOME/.local/share/namada
Environment=CMT_LOG_LEVEL=p2p:none,pex:error
Environment=NAMADA_CMT_STDOUT=true
ExecStart=/usr/local/bin/namada node ledger run 
StandardOutput=syslog
StandardError=syslog
Restart=always
RestartSec=10
LimitNOFILE=65535
[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable namadad
sudo systemctl restart namadad
