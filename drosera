#!/bin/bash

PS3='🔧 Обери дію: '
options=(
    "1. Підготовка сервера та деплой трапа"
    "2. Dryrun та перехід у Private Trap"
    "3. Встановлення Drosera Operator та запуск ноди"
    "4. Перегляд логів та Opt-in"
    "5. Вихід"
)

select opt in "${options[@]}"
do
    case $REPLY in

        1)
            echo "🚀 Починаємо підготовку сервера та деплой трапа..."

            sudo apt-get update && sudo apt-get upgrade -y && \
            sudo apt install curl ufw iptables build-essential git wget lz4 jq make gcc nano automake autoconf tmux htop nvme-cli libgbm1 pkg-config libssl-dev libleveldb-dev tar clang bsdmainutils ncdu unzip libleveldb-dev -y

            echo "✅ Drosera CLI встановлюється..."
            curl -L https://app.drosera.io/install | bash && source ~/.bashrc && droseraup

            echo "✅ Foundry встановлюється..."
            curl -L https://foundry.paradigm.xyz | bash && source ~/.bashrc && foundryup

            echo "📁 Ініціалізація Drosera проєкту..."
            mkdir -p ~/my-drosera-trap
            cd ~/my-drosera-trap

            read -p "Введи свій GitHub email: " GITHUB_EMAIL
            read -p "Введи свій GitHub username: " GITHUB_USERNAME

            git config --global user.email "$GITHUB_EMAIL"
            git config --global user.name "$GITHUB_USERNAME"

            forge init -t drosera-network/trap-foundry-template

            echo "📦 Встановлюємо Bun..."
            curl -fsSL https://bun.sh/install | bash && source ~/.bashrc && bun install && forge build

            read -p "🔑 Введи приватний ключ гаманця з Holesky: " PRIV_KEY
            export DROSERA_PRIVATE_KEY="$PRIV_KEY"

            echo "🧠 Застосовуємо trap..."
            drosera apply

            echo "➡️ Введи 'ofc' у терміналі після підтвердження."

            ;;

        2)
            echo "🛠 Dryrun + перехід у Private Trap..."
            drosera dryrun && cd

            cd ~/my-drosera-trap && source ~/.bashrc

            sed -i '/^private_trap/d' ~/my-drosera-trap/drosera.toml
            sed -i '/^whitelist/d' ~/my-drosera-trap/drosera.toml

            read -p "📬 Введи адресу свого гаманця: " ADDRESS
            read -p "🔑 Введи ще раз приватний ключ гаманця: " PRIV_KEY
            export DROSERA_PRIVATE_KEY="$PRIV_KEY"

            echo "private_trap = true" >> ~/my-drosera-trap/drosera.toml
            echo "whitelist = [\"$ADDRESS\"]" >> ~/my-drosera-trap/drosera.toml

            echo "🔄 Повторна активація trap..."
            drosera apply

            echo "➡️ Введи 'ofc' у терміналі після підтвердження."

            ;;

        3)
            echo "📦 Встановлення Drosera Operator..."
            cd ~/my-drosera-trap && curl -LO https://github.com/drosera-network/releases/releases/download/v1.16.2/drosera-operator-v1.16.2-x86_64-unknown-linux-gnu.tar.gz && \
            tar -xvf drosera-operator-v1.16.2-x86_64-unknown-linux-gnu.tar.gz && \
            sudo cp drosera-operator /usr/bin

            drosera-operator register --eth-rpc-url https://ethereum-holesky-rpc.publicnode.com --eth-private-key $DROSERA_PRIVATE_KEY

            sudo ufw allow 31313
            sudo ufw allow 31314

            echo "🛠 Створення systemd сервісу..."
            sudo tee /etc/systemd/system/drosera.service > /dev/null <<EOF
[Unit]
Description=Drosera Node Service
After=network-online.target

[Service]
User=$USER
Restart=always
RestartSec=15
LimitNOFILE=65535
ExecStart=$(which drosera-operator) node --db-file-path /root/.drosera.db --network-p2p-port 31313 --server-port 31314 \\
    --eth-rpc-url https://ethereum-holesky-rpc.publicnode.com \\
    --eth-backup-rpc-url https://1rpc.io/holesky \\
    --drosera-address 0xea08f7d533C2b9A62F40D5326214f39a8E3A32F8 \\
    --eth-private-key $DROSERA_PRIVATE_KEY \\
    --listen-address 0.0.0.0 \\
    --network-external-p2p-address $(curl -s https://api.ipify.org) \\
    --disable-dnr-confirmation true
EOF

            sudo systemctl daemon-reload
            sudo systemctl enable drosera
            sudo systemctl restart drosera

            echo "✅ Drosera сервіс запущено"

            ;;

        4)
            echo "📋 Вивід логів Drosera ноди..."
            journalctl -u drosera -f -o cat

            echo "📩 Опціональна участь (opt-in)..."
            drosera-operator optin \
                --eth-rpc-url https://ethereum-holesky-rpc.publicnode.com \
                --eth-private-key $DROSERA_PRIVATE_KEY \
                --trap-config-address 0xd0fe1a638553b6461c5675332ed3816239cf1606

            ;;

        5)
            echo "👋 Вихід з меню. Гарного дня!"
            break
            ;;

        *)
            echo "❗ Невірний вибір. Спробуй ще раз."
            ;;
    esac
done
